name: Update Product Formula in Tap
run-name: Update ${{ github.event.client_payload.name }} to ${{ github.event.client_payload.version }}
# This workflow will automatically update our product formulae on the release of
# new versions
on:
  repository_dispatch:
    types: [version-updated]

jobs:
  check-version:
    name: Check if update is needed
    runs-on: ubuntu-latest
    outputs:
      should_update: ${{ steps.version_check.outputs.should_update }}
      current_version: ${{ steps.version_check.outputs.current_version }}
      incoming_version: ${{ steps.version_check.outputs.incoming_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 #v6.0.0
        with:
          token: ${{ secrets.HOMEBREW_TAP_UPDATER_TOKEN }}

      - name: Check if version is latest
        id: version_check
        run: |
          # Run the version check script and capture its output
          SCRIPT_OUTPUT=$(./.github/scripts/check-version.sh \
            "${{ github.event.client_payload.name }}" \
            "${{ github.event.client_payload.version }}" \
            "${{ github.event.client_payload.cask }}")
          
          # Parse the output and set GitHub Action outputs
          echo "$SCRIPT_OUTPUT" | while IFS='=' read -r key value; do
            if [[ -n "$key" && -n "$value" ]]; then
              echo "$key=$value" >> $GITHUB_OUTPUT
            fi
          done

      - name: Display version information
        run: |
          echo "::notice::Version Check Results"
          echo "::notice::Product: ${{ github.event.client_payload.name }}"
          echo "::notice::Current Version: ${{ steps.version_check.outputs.current_version }}"
          echo "::notice::Incoming Version: ${{ steps.version_check.outputs.incoming_version }}"
          echo "::notice::Should Update: ${{ steps.version_check.outputs.should_update }}"

      - name: Skip update notification
        if: ${{ steps.version_check.outputs.should_update == 'false' }}
        run: |
          echo "::notice::Skipping update for ${{ github.event.client_payload.name }}. Incoming version ${{ github.event.client_payload.version }} is not newer than the current version."

  update-formula:
    name: Update Formula
    runs-on: ubuntu-latest
    needs: check-version
    if: ${{ needs.check-version.outputs.should_update == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 #v6.0.0
        with:
          # token under hc-github-team-es-release-engineering user
          token: ${{ secrets.HOMEBREW_TAP_UPDATER_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 #v6.0.0
        with:
          go-version-file: "util/formula_templater/go.mod"

      - name: Build formula_templater CLI
        run: |
          cd util/formula_templater && go build

      - name: Generate new formula
        if: ${{ github.event.client_payload.cask == 'false' }}
        run: |
          ./util/formula_templater/formula_templater \
            ${{github.event.client_payload.name}} \
            ${{github.event.client_payload.version}} \
            ./util/formula_templater/config.hcl > ./Formula/${{github.event.client_payload.name}}.rb

      - name: Generate new cask
        if: ${{ github.event.client_payload.cask == 'true' }}
        run: |
          ./util/formula_templater/formula_templater \
            -cask \
            ${{github.event.client_payload.name}} \
            ${{github.event.client_payload.version}} \
            ./util/formula_templater/config.hcl > ./Casks/hashicorp-${{github.event.client_payload.name}}.rb

      - name: Publish Change
        run: |
          git config user.name hc-github-team-es-release-engineering
          git config user.email github-team-es-release-engineering@hashicorp.com
          
          git add Formula/*.rb Casks/*.rb

          git commit -m "Bump ${{ github.event.client_payload.name }} to ${{ github.event.client_payload.version }}"

          # Ensure we have any changes that might have been merged before we push. This narrows the window in which a
          # race from multiple changes happening at once can occur. Conflicts/Races could still occur though unlikley.
          git pull --rebase

          git push
